name: "test"
on: push
jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    environment: test_env
    defaults:
        run:
          working-directory: my-blog
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install dependencies
        run: npm install
      - name: Build Docker Image
        run: docker build -t myapp .
      - name: Save Docker image as tar.gz
        run: |
          docker save myapp > myapp.tar
          gzip myapp.tar
      - name: Install SSH Client
        run: sudo apt-get install -y openssh-client
      - name: Upload Docker Image to EC2
        env:
          SSH_KEY: ${{ secrets.AWS_EC2_SSH_KEY }}
          HOST: "3.77.57.17"
          USER: "ec2-user"
        run: |
          echo "$SSH_KEY" > deploy_key
          chmod 600 deploy_key
          scp -i deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null myapp.tar.gz $USER@$HOST:~
  
      - name: Deploy and Run on EC2
        env:
            SSH_KEY: ${{ secrets.AWS_EC2_SSH_KEY }}
            HOST: "3.77.57.17"
            USER: "ec2-user"
        run: |
          ssh -i deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $USER@$HOST "
            docker load < myapp.tar.gz
            docker run -d myapp
          "